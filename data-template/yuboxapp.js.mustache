$(document).ready(function () {
{{#modules}}
    {{#module_setupjs}}
    {{{module_setupjs}}}();
    {{/module_setupjs}}
{{/modules}}

    // Mostrar el tab preparado por omisión como activo
    $('ul#yuboxMainTab a.set-active').removeClass('set-active').tab('show');
});

{{#modules}}
{{{module_content}}}
{{/modules}}

function yuboxAPI(s)
{
    var mockup =  window.location.pathname.startsWith('/yubox-mockup/');
    return mockup
        ? '/yubox-mockup/'+s+'.php'
        : '/yubox-api/'+s;
}

function yuboxMostrarAlertText(alertstyle, text, timeout)
{
    var content = $('<span></span>').text(text);
    return yuboxMostrarAlert(alertstyle, content, timeout);
}

function yuboxMostrarAlert(alertstyle, content, timeout)
{
    return yuboxDlgMostrarAlert('main > div.container', alertstyle, content, timeout);
}

function yuboxDlgMostrarAlertText(basesel, alertstyle, text, timeout)
{
    var content = $('<span></span>').text(text);
    return yuboxDlgMostrarAlert(basesel, alertstyle, content, timeout);
}

function yuboxDlgMostrarAlert(basesel, alertstyle, content, timeout)
{
    var al = $(basesel).children('div.alert.yubox-alert-template')
        .clone()
        .removeClass('yubox-alert-template')
        .addClass('yubox-alert')
        .addClass('alert-'+alertstyle);
    al.find('button.close').before(content);

    $(basesel).children('div.yubox-alert').remove();
    $(basesel).children('div.alert.yubox-alert-template').after(al);
    if (timeout != undefined) {
        setTimeout(function() {
            al.remove();
        }, timeout);
    }

    return al;
}

function yuboxStdAjaxFailHandler(e, timeout)
{
    yuboxStdAjaxFailHandlerDlg('main > div.container', e, timeout);
}

function yuboxStdAjaxFailHandlerDlg(basesel, e, timeout)
{
    var msg;
    if (e.status == 0) {
        msg = 'Fallo al contactar dispositivo';
    } else if (e.responseJSON == undefined) {
        msg = 'Tipo de contenido inesperado en respuesta';
    } else {
        msg = e.responseJSON.msg;
    }
    yuboxDlgMostrarAlertText(basesel, 'danger', msg, timeout);
}

function getYuboxPane(modname, raw = false)
{
    let dom = document.querySelector('div#yuboxMainTabContent > div.tab-pane#'+modname);
    return raw ? dom : yuboxWrapJQ(dom);
}
function getYuboxNavTab(modname, raw = false)
{
    let dom = document.querySelector('ul#yuboxMainTab a#'+modname+'-tab[data-toggle="tab"]');
    return raw ? dom : yuboxWrapJQ(dom);
}

// Las siguientes dos funciones envuelven un DOM pelado en jQuery, y lo extraen
// de un objeto jQuery, si jQuery está presente. De lo contrario, no hacen nada.
function yuboxWrapJQ(domobj)
{
    if (typeof jQuery == 'undefined') return domobj;
    return $(domobj);
}
function yuboxUnwrapJQ(jqobj)
{
    if (typeof jQuery == 'undefined') return jqobj;
    if (!(jqobj instanceof jQuery)) return jqobj;
    if (jqobj.length > 0) return jqobj[0];
    return null;
}